services:
  web:
    build:
      context: ..
      dockerfile: shop/Dockerfile
    expose:
      - "3000"
    env_file:
      - ../.env
    environment:
      # Database
      DATABASE_URL: ${SHOP_DATABASE_URL}
      SHOP_DB_USER: ${SHOP_DB_USER}
      SHOP_DB_PASSWORD: ${SHOP_DB_PASSWORD}

      # NextAuth
      NEXTAUTH_SECRET: ${SHOP_NEXTAUTH_SECRET}
      NEXTAUTH_URL: ${SHOP_NEXTAUTH_URL}

      # OAuth
      AUTH_GOOGLE_ID: ${SHOP_AUTH_GOOGLE_ID}
      AUTH_GOOGLE_SECRET: ${SHOP_AUTH_GOOGLE_SECRET}

      # Stripe
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}

      # Auth Service Integration
      AUTH_SECRET: ${SHOP_AUTH_SECRET}
      AUTH_TRUST_HOST: ${SHOP_AUTH_TRUST_HOST}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
    networks:
      - traefik-public
    external_links:
      - shared-postgres
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # HTTP Router
      - "traefik.http.routers.shop.rule=Host(`shop.korczewski.de`)"
      - "traefik.http.routers.shop.entrypoints=websecure"
      - "traefik.http.routers.shop.tls=true"

      # Service configuration
      - "traefik.http.services.shop.loadbalancer.server.port=3000"

      # Middlewares
      - "traefik.http.routers.shop.middlewares=default-chain@file"

networks:
  traefik-public:
    external: true
    name: traefik-public
