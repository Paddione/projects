// Mock jsonwebtoken module for testing

export class JsonWebTokenError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'JsonWebTokenError';
  }
}

export class TokenExpiredError extends Error {
  public expiredAt: Date;
  
  constructor(message: string, expiredAt: Date) {
    super(message);
    this.name = 'TokenExpiredError';
    this.expiredAt = expiredAt;
  }
}

const mockSign = jest.fn().mockImplementation((payload: any, secret: string, options?: any) => {
  console.log('JWT Mock sign called with:', { payload, secret, options });
  
  // Create a proper JWT-like token with the actual payload
  const header = Buffer.from(JSON.stringify({ alg: 'HS256', typ: 'JWT' })).toString('base64url');
  const payloadWithDefaults = {
    ...payload,
    iat: Math.floor(Date.now() / 1000),
    exp: Math.floor(Date.now() / 1000) + (options?.expiresIn === '7d' ? 7 * 24 * 60 * 60 : 15 * 60),
    iss: options?.issuer || 'learn2play-api',
    aud: options?.audience || 'learn2play-client'
  };
  const payloadBase64 = Buffer.from(JSON.stringify(payloadWithDefaults)).toString('base64url');
  const signature = 'mock-signature';
  
  return `${header}.${payloadBase64}.${signature}`;
});

const mockVerify = jest.fn().mockImplementation((token: string, secret: string, options?: any) => {
  console.log('JWT Mock verify called with:', { token, secret, options });
  
  // Handle mock tokens generated by our mock sign function
  if (token.startsWith('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.')) {
    // Decode the payload from the mock token
    try {
      const parts = token.split('.');
      if (parts.length === 3) {
        const payload = JSON.parse(Buffer.from(parts[1], 'base64').toString());
        return payload;
      }
    } catch (e) {
      // Fallback to default payload
    }
    
    // Default payload for mock tokens
    return {
      userId: 999,
      username: 'admin-test',
      email: 'admin@test.local',
      selectedCharacter: 'professor',
      characterLevel: 1,
      isAdmin: true,
      iat: Math.floor(Date.now() / 1000),
      exp: Math.floor(Date.now() / 1000) + (15 * 60),
      iss: 'learn2play-api',
      aud: 'learn2play-client'
    };
  }
  
  if (token === 'valid-token' || token === 'valid-refresh-token') {
    return {
      userId: 1,
      username: 'testuser',
      email: 'test@example.com',
      selectedCharacter: 'student',
      characterLevel: 1,
      isAdmin: false
    };
  }
  throw new JsonWebTokenError('Invalid token');
});

export const sign = mockSign;
export const verify = mockVerify;

// CommonJS compatibility
module.exports = {
  sign: mockSign,
  verify: mockVerify,
  JsonWebTokenError,
  TokenExpiredError
};
