# =============================================================================
# Skaffold Configuration
# =============================================================================
apiVersion: skaffold/v4beta11
kind: Config
metadata:
  name: korczewski-k8s

# =============================================================================
# Build Configuration
# =============================================================================
build:
  local:
    push: false
    useBuildkit: true
    concurrency: 2

  artifacts:
    # Auth Service
    - image: korczewski/auth
      context: ..
      docker:
        dockerfile: auth/Dockerfile
      sync:
        manual:
          - src: "src/**/*.ts"
            dest: /app/src

    # L2P Backend
    - image: korczewski/l2p-backend
      context: ..
      docker:
        dockerfile: l2p/backend/Dockerfile

    # L2P Frontend
    - image: korczewski/l2p-frontend
      context: ..
      docker:
        dockerfile: l2p/frontend/Dockerfile
        buildArgs:
          VITE_API_URL: "https://l2p.korczewski.de/api"
          VITE_SOCKET_URL: "https://l2p.korczewski.de"
          VITE_AUTH_SERVICE_URL: "https://auth.korczewski.de"

    # Shop Service
    - image: korczewski/shop
      context: ..
      docker:
        dockerfile: shop/Dockerfile

    # VideoVault
    - image: korczewski/videovault
      context: ..
      docker:
        dockerfile: VideoVault/Dockerfile.prod

# =============================================================================
# Manifest Configuration
# =============================================================================
manifests:
  kustomize:
    paths:
      - infrastructure/postgres
      - infrastructure/traefik
      - infrastructure/smb-csi
      - services/auth
      - services/l2p-backend
      - services/l2p-frontend
      - services/shop
      - services/videovault
  rawYaml:
    - base/namespaces.yaml

# =============================================================================
# Deploy Configuration
# =============================================================================
deploy:
  kubectl:
    hooks:
      before:
        - host:
            command:
              [
                "bash",
                "-c",
                "kubectl get ns korczewski-infra || kubectl apply -f base/namespaces.yaml",
              ]

# =============================================================================
# Port Forwarding
# =============================================================================
portForward:
  - resourceType: service
    resourceName: postgres
    namespace: korczewski-infra
    port: 5432
    localPort: 5432
  - resourceType: service
    resourceName: traefik-dashboard
    namespace: korczewski-infra
    port: 8080
    localPort: 8080
  - resourceType: service
    resourceName: auth
    namespace: korczewski-services
    port: 5500
    localPort: 5500
  - resourceType: service
    resourceName: l2p-backend
    namespace: korczewski-services
    port: 3001
    localPort: 3001
  - resourceType: service
    resourceName: l2p-frontend
    namespace: korczewski-services
    port: 80
    localPort: 3000
  - resourceType: service
    resourceName: shop
    namespace: korczewski-services
    port: 3000
    localPort: 3004
  - resourceType: service
    resourceName: videovault
    namespace: korczewski-services
    port: 5000
    localPort: 5100

# =============================================================================
# Profiles
# =============================================================================
profiles:
  # Auth only
  - name: auth
    build:
      artifacts:
        - image: korczewski/auth
          context: ..
          docker:
            dockerfile: auth/Dockerfile
    manifests:
      kustomize:
        paths:
          - services/auth

  # L2P only (backend + frontend)
  - name: l2p
    build:
      artifacts:
        - image: korczewski/l2p-backend
          context: ..
          docker:
            dockerfile: l2p/backend/Dockerfile
        - image: korczewski/l2p-frontend
          context: ..
          docker:
            dockerfile: l2p/frontend/Dockerfile
    manifests:
      kustomize:
        paths:
          - services/l2p-backend
          - services/l2p-frontend

  # Shop only
  - name: shop
    build:
      artifacts:
        - image: korczewski/shop
          context: ..
          docker:
            dockerfile: shop/Dockerfile
    manifests:
      kustomize:
        paths:
          - services/shop

  # VideoVault only
  - name: videovault
    build:
      artifacts:
        - image: korczewski/videovault
          context: ..
          docker:
            dockerfile: VideoVault/Dockerfile.prod
    manifests:
      kustomize:
        paths:
          - services/videovault

  # Infrastructure only (no builds)
  - name: infra
    manifests:
      kustomize:
        paths:
          - infrastructure/postgres
          - infrastructure/traefik
          - infrastructure/smb-csi
      rawYaml:
        - base/namespaces.yaml
