---
# =============================================================================
# Cert Renewal CronJob
# =============================================================================
# Renews *.korczewski.de wildcard cert via Let's Encrypt DNS-01 with IPv64.
# Runs monthly on the 1st at 03:00 UTC. Updates the korczewski-tls secret
# and restarts Traefik to pick up the new cert.
#
# Manual trigger: kubectl create job cert-renewal-manual --from=cronjob/cert-renewal -n korczewski-infra
# =============================================================================

apiVersion: batch/v1
kind: CronJob
metadata:
  name: cert-renewal
  namespace: korczewski-infra
  labels:
    app: cert-renewal
    app.kubernetes.io/name: cert-renewal
    app.kubernetes.io/component: tls
spec:
  schedule: "0 3 1 * *"  # 1st of every month at 03:00 UTC
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 3
      activeDeadlineSeconds: 600
      template:
        metadata:
          labels:
            app: cert-renewal
        spec:
          serviceAccountName: cert-renewal
          restartPolicy: OnFailure
          nodeSelector:
            kubernetes.io/arch: amd64
          containers:
            - name: cert-renewal
              image: neilpang/acme.sh:latest
              command: ["/bin/sh", "-c"]
              args:
                - |
                  set -e

                  echo "=== Cert Renewal: $(date) ==="

                  # Register account if needed
                  acme.sh --register-account -m "$ACME_EMAIL" --server letsencrypt 2>/dev/null || true

                  # Issue/renew wildcard cert using IPv64 DNS-01
                  echo "Requesting wildcard cert for *.korczewski.de..."
                  acme.sh --issue \
                    --dns dns_ipv64 \
                    -d "*.korczewski.de" \
                    -d "korczewski.de" \
                    --server letsencrypt \
                    --force \
                    --keylength ec-256

                  # Read the cert and key
                  CERT_DIR="/acme.sh/*.korczewski.de_ecc"
                  CERT=$(cat "$CERT_DIR/fullchain.cer" | base64 | tr -d '\n')
                  KEY=$(cat "$CERT_DIR/*.korczewski.de.key" | base64 | tr -d '\n')

                  echo "Cert obtained, updating Kubernetes secret via API..."

                  # Use the Kubernetes API directly with the service account token
                  SA_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
                  API_SERVER="https://kubernetes.default.svc"
                  CA_CERT="/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"

                  # Update the korczewski-tls secret
                  apk add --no-cache curl jq >/dev/null 2>&1

                  SECRET_JSON=$(cat <<ENDJSON
                  {
                    "apiVersion": "v1",
                    "kind": "Secret",
                    "metadata": {
                      "name": "korczewski-tls",
                      "namespace": "korczewski-infra"
                    },
                    "type": "kubernetes.io/tls",
                    "data": {
                      "tls.crt": "${CERT}",
                      "tls.key": "${KEY}"
                    }
                  }
                  ENDJSON
                  )

                  # Try PUT (update), fall back to POST (create) on 404
                  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                    --cacert "$CA_CERT" \
                    -H "Authorization: Bearer $SA_TOKEN" \
                    -H "Content-Type: application/json" \
                    -X PUT \
                    -d "$SECRET_JSON" \
                    "$API_SERVER/api/v1/namespaces/korczewski-infra/secrets/korczewski-tls")

                  if [ "$HTTP_CODE" = "404" ]; then
                    curl -sf --cacert "$CA_CERT" \
                      -H "Authorization: Bearer $SA_TOKEN" \
                      -H "Content-Type: application/json" \
                      -X POST \
                      -d "$SECRET_JSON" \
                      "$API_SERVER/api/v1/namespaces/korczewski-infra/secrets"
                  elif [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ]; then
                    echo "ERROR: Failed to update secret (HTTP $HTTP_CODE)"
                    exit 1
                  fi

                  echo "Secret updated successfully"

                  # Restart Traefik by patching the deployment annotation
                  PATCH_JSON="{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"cert-renewal/restartedAt\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}}}}}"
                  curl -sf --cacert "$CA_CERT" \
                    -H "Authorization: Bearer $SA_TOKEN" \
                    -H "Content-Type: application/strategic-merge-patch+json" \
                    -X PATCH \
                    -d "$PATCH_JSON" \
                    "$API_SERVER/apis/apps/v1/namespaces/korczewski-infra/deployments/traefik"

                  echo "=== Cert renewal complete ==="
              env:
                - name: IPv64_Token
                  valueFrom:
                    secretKeyRef:
                      name: cert-renewal-credentials
                      key: IPV64_API_KEY
                - name: ACME_EMAIL
                  value: "patrick@korczewski.de"
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "256Mi"
                  cpu: "500m"
