services:
  videovault-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: videovault-dev
    expose:
      - "5000"
    volumes:
      # Mount source code for hot reload
      - ./client:/app/client:cached
      - ./server:/app/server:cached
      - ./shared:/app/shared:cached
      - ./docs:/app/docs:cached

      # Mount config files
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./vite.config.ts:/app/vite.config.ts:ro
      - ./tailwind.config.cjs:/app/tailwind.config.cjs:ro

      # Mount media directory
      - ${MEDIA_ROOT:-./Bibliothek}:/app/media

      # Preserve node_modules in container (don't mount host node_modules)
      - /app/node_modules
    environment:
      - MEDIA_ROOT=/app/media
    env_file:
      - .env-prod
    stdin_open: true
    tty: true
    command: sh -lc "npm ci && npm run dev"
    restart: unless-stopped
    networks:
      - l2p-network
      - traefik-public
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # HTTP Router
      - "traefik.http.routers.videovault.rule=Host(`videovault.korczewski.de`, `video.korczewski.de`)"
      - "traefik.http.routers.videovault.priority=10"
      - "traefik.http.routers.videovault.entrypoints=websecure"
      - "traefik.http.routers.videovault.tls=true"

      # Service configuration
      - "traefik.http.services.videovault.loadbalancer.server.port=5000"

      # Middlewares
      - "traefik.http.routers.videovault.middlewares=default-chain@file"
    external_links:
      - shared-postgres
    healthcheck:
      test: ['CMD-SHELL', 'curl -fsS http://localhost:5000/api/health || exit 1']
      interval: 5s
      timeout: 3s
      retries: 30
    # Docker Compose watch mode for automatic file sync
    develop:
      watch:
        - action: sync
          path: ./client
          target: /app/client
          ignore:
            - "**/*.test.ts"
            - "**/*.test.tsx"
            - "**/__tests__"
        - action: sync
          path: ./server
          target: /app/server
          ignore:
            - "**/*.test.ts"
        - action: sync
          path: ./shared
          target: /app/shared
        - action: rebuild
          path: ./package.json
        - action: sync+restart
          path: ./vite.config.ts
          target: /app/vite.config.ts

  # Optional PostgreSQL for future server persistence
  # NOW USING CENTRALIZED POSTGRES INSTANCE
  # The shared-postgres instance is managed in /shared-infrastructure
  # This service definition is removed - using shared-postgres instead
  # postgres:
  #   image: postgres:16-alpine
  #   ... (removed, using shared-postgres instead)

  playwright:
    image: mcr.microsoft.com/playwright:v1.55.0-jammy
    container_name: videovault-playwright
    profiles:
      - playwright
    working_dir: /work
    networks:
      - l2p-network
    env_file:
      - env/.env-playwright
    depends_on:
      videovault-dev:
        condition: service_healthy
    external_links:
      - shared-postgres
    shm_size: 1g
    environment:
      - CI=1
      - PW_SKIP_WEB_SERVER=1
      - PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
      - BASE_URL=http://videovault-dev:5000
      - NODE_ENV=development
    volumes:
      - ./:/work:cached
      - /work/node_modules
    # Install deps and run Playwright tests
    command: bash -lc "npm ci && npm run test:pw"

  playwright-ui:
    image: mcr.microsoft.com/playwright:v1.55.0-jammy
    container_name: videovault-playwright-ui
    profiles:
      - playwright
    working_dir: /work
    networks:
      - l2p-network
    env_file:
      - env/.env-playwright
    depends_on:
      videovault-dev:
        condition: service_healthy
    external_links:
      - shared-postgres
    shm_size: 1g
    environment:
      - CI=1
      - PW_SKIP_WEB_SERVER=1
      - PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
      - BASE_URL=http://videovault-dev:5000
      - NODE_ENV=development
    ports:
      - '0.0.0.0:9323:9323'
    volumes:
      - ./:/work:cached
      - /work/node_modules
    command: bash -lc "npm ci && npm run test:pw:ui -- --ui-host 0.0.0.0 --ui-port 9323"

networks:
  l2p-network:
    external: true
    name: l2p-network
  traefik-public:
    external: true
    name: traefik-public
# Volumes removed - using centralized postgres instance
